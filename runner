#! /bin/bash

TEMP_NAME=$( date +"%d-%H_%M")
TRIAL=${3:-$TEMP_NAME}
RUN_NAME=$2_$1_$TRIAL
DATA_FOLDER=Result/$RUN_NAME
mkdir -p DATA_FOLDER

#clear the machines for running
for i in `seq 1 $2`;
do
  ssh qian-test$i -t "cd TileDB-multinode; make mpi-prod"
done;

#1 = datatsize, 2 = number of nodes including master, 3 = trial number
#ex: ./runner 500 8 

#run the actual thing
make mpi-prod && mpiexec -n $2 -f machinefile_prod ./mpi_main $1 > $DATA_FOLDER/master.txt

#get the data from each machine
for i in `seq 1 $2`;
do
  scp qian-test$i:~/TileDB-multinode/workspaces/workspaces-$i/logfile $DATA_FOLDER/machine_$i.txt
done;
